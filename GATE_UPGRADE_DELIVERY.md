# Gate æ¨¡å‹å‡çº§ - å®Œæ•´äº¤ä»˜æ–‡æ¡£

## ğŸ“‹ å‡çº§ç›®æ ‡

å°†é‡Œç¨‹ç¢‘ç³»ç»Ÿä»"æ­¥éª¤"å‡çº§ä¸º"Gateï¼ˆæ§åˆ¶ç‚¹ï¼‰æ¨¡å‹"ï¼Œå®ç°"å¡é£é™©ï¼Œè€Œä¸æ˜¯èµ°æµç¨‹"ã€‚

---

## âœ… å·²å®Œæˆå†…å®¹

### 1. Gate æ¨¡æ¿è®¾è®¡ âœ…

**æ–‡ä»¶ï¼š** `lib/domain/gateTemplate.ts`

**æ¨¡æ¿ç»“æ„ï¼š**
- 17 ä¸ªå…³é”®æ§åˆ¶ç‚¹ï¼ˆè¦†ç›–å¤–è´¸å…¨æµç¨‹ï¼‰
- 5 ä¸ªé˜¶æ®µåˆ†ç»„ï¼šè®¢å•åˆæ³•æ€§ / åŸè¾…æ–™ / ç”Ÿäº§ / QC / å‡ºè´§
- æ¯ä¸ª Gate åŒ…å«ï¼š
  - `gate_key`ï¼ˆè‹±æ–‡å”¯ä¸€æ ‡è¯†ï¼‰
  - `name`ï¼ˆä¸­æ–‡åç§°ï¼‰
  - `stage`ï¼ˆæ‰€å±é˜¶æ®µï¼‰
  - `owner_role`ï¼ˆè´Ÿè´£äººè§’è‰²ï¼‰
  - `required`ï¼ˆæ˜¯å¦ä¸ºå¼ºåˆ¶ Gateï¼‰
  - `depends_on`ï¼ˆä¾èµ–çš„ gate_key åˆ—è¡¨ï¼‰
  - `days_before_target`ï¼ˆç›¸å¯¹ç›®æ ‡æ—¥æœŸçš„å¤©æ•°ï¼‰
  - `is_critical`ï¼ˆæ˜¯å¦å…³é”®ï¼‰
  - `evidence_required`ï¼ˆæ˜¯å¦éœ€è¦å‡­è¯ï¼‰

**Gate åˆ—è¡¨ï¼š**

#### é˜¶æ®µ 1ï¼šè®¢å•åˆæ³•æ€§ï¼ˆ3ä¸ªï¼‰
1. POç¡®è®¤ï¼ˆå¼ºåˆ¶ï¼‰
2. è´¢åŠ¡å®¡æ ¸ï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šPOç¡®è®¤ï¼‰
3. è®¢å•èµ„æ–™é½å…¨ï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šPOç¡®è®¤ï¼‰

#### é˜¶æ®µ 2ï¼šåŸè¾…æ–™ï¼ˆ3ä¸ªï¼‰
4. åŸè¾…æ–™é‡‡è´­ï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šè´¢åŠ¡å®¡æ ¸ã€è®¢å•èµ„æ–™é½å…¨ï¼‰
5. åŸè¾…æ–™åˆ°ä½ï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šåŸè¾…æ–™é‡‡è´­ï¼‰
6. åŸè¾…æ–™éªŒæ”¶ï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šåŸè¾…æ–™åˆ°ä½ï¼‰

#### é˜¶æ®µ 3ï¼šç”Ÿäº§ï¼ˆ7ä¸ªï¼‰
7. äº§å‰æ ·å®Œæˆï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šåŸè¾…æ–™éªŒæ”¶ï¼‰
8. äº§å‰æ ·å¯„å‡ºï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šäº§å‰æ ·å®Œæˆï¼‰
9. äº§å‰æ ·ç¡®è®¤ï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šäº§å‰æ ·å¯„å‡ºï¼‰
10. å·¥å‚ä¸Šçº¿ï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šäº§å‰æ ·ç¡®è®¤ï¼‰
11. ä¸­æŸ¥ï¼ˆå»ºè®®ï¼Œä¾èµ–ï¼šå·¥å‚ä¸Šçº¿ï¼‰
12. åŒ…è£…è¾…æ–™åˆ°ä½ï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šå·¥å‚ä¸Šçº¿ï¼‰
13. å°¾æŸ¥ï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šä¸­æŸ¥ã€åŒ…è£…è¾…æ–™åˆ°ä½ï¼‰

#### é˜¶æ®µ 4ï¼šQCï¼ˆ2ä¸ªï¼‰
14. QCéªŒè´§é¢„çº¦ï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šå°¾æŸ¥ï¼‰
15. QCéªŒè´§å®Œæˆï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šQCéªŒè´§é¢„çº¦ï¼‰

#### é˜¶æ®µ 5ï¼šå‡ºè´§ï¼ˆ2ä¸ªï¼‰
16. è®¢èˆ±å®Œæˆï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šQCéªŒè´§å®Œæˆï¼‰
17. å‡ºè´§å®Œæˆï¼ˆå¼ºåˆ¶ï¼Œä¾èµ–ï¼šè®¢èˆ±å®Œæˆï¼‰

---

### 2. Gate æ—¶é—´è®¡ç®— âœ…

**æ–‡ä»¶ï¼š** `lib/utils/gate-scheduler.ts`

**åŠŸèƒ½ï¼š**
- æ ¹æ®ç›®æ ‡æ—¥æœŸï¼ˆETD æˆ– Warehouse Due Dateï¼‰è®¡ç®—æ¯ä¸ª Gate çš„ `planned_at` å’Œ `due_at`
- æ ¹æ®è®¢å•ç±»å‹ï¼ˆsample/bulkï¼‰å’ŒåŒ…è£…ç±»å‹ï¼ˆstandard/customï¼‰è°ƒæ•´æ—¶é—´
- å¤„ç†å·¥ä½œæ—¥è®¡ç®—ï¼ˆæ’é™¤å‘¨æœ«ï¼‰

**å…³é”®å‡½æ•°ï¼š**
- `calculateGateSchedule()` - è®¡ç®—æ‰€æœ‰ Gate çš„æ—¶é—´è¡¨
- `canGateStart()` - æ£€æŸ¥ Gate æ˜¯å¦å¯ä»¥å¼€å§‹
- `getNextAvailableGate()` - è·å–ä¸‹ä¸€ä¸ªå¯å¼€å§‹çš„ Gate

---

### 3. Gate ä¾èµ–æ£€æŸ¥ âœ…

**æ–‡ä»¶ï¼š** `lib/repositories/milestonesRepo.ts`

**åŠŸèƒ½ï¼š**
- `checkGateDependencies()` - æ£€æŸ¥ Gate ä¾èµ–æ˜¯å¦æ»¡è¶³
- åœ¨ `transitionMilestoneStatus()` ä¸­é›†æˆä¾èµ–æ£€æŸ¥
- è§„åˆ™ï¼šrequired Gate æœªé€šè¿‡å‰ï¼Œåç»­ Gate ä¸å¯è¿›å…¥"è¿›è¡Œä¸­"

**æ£€æŸ¥é€»è¾‘ï¼š**
```typescript
// å¦‚æœè¦è¿›å…¥"è¿›è¡Œä¸­"çŠ¶æ€ï¼Œæ£€æŸ¥ä¾èµ–çš„ required Gate æ˜¯å¦å·²å®Œæˆ
if (normalizedNextStatus === 'è¿›è¡Œä¸­') {
  const depCheck = await checkGateDependencies(supabase, milestone.order_id, milestone);
  if (!depCheck.canProceed) {
    return { error: depCheck.reason || 'ä¾èµ–çš„æ§åˆ¶ç‚¹å°šæœªå®Œæˆ' };
  }
}
```

---

### 4. åˆ›å»ºè®¢å•æµç¨‹æ›´æ–° âœ…

**æ–‡ä»¶ï¼š** `app/actions/orders.ts`

**ä¿®æ”¹ï¼š**
- ç§»é™¤æ—§çš„ `MILESTONE_TEMPLATE_V1` å’Œ `calcDueDates()`
- ä½¿ç”¨æ–°çš„ `calculateGateSchedule()` è®¡ç®— Gate æ—¶é—´è¡¨
- å‡†å¤‡é‡Œç¨‹ç¢‘æ•°æ®æ—¶åŒ…å«æ–°å­—æ®µï¼ˆ`stage`, `required`, `depends_on`ï¼‰

---

### 5. Step 2 UI å‡çº§ âœ…

**æ–‡ä»¶ï¼š** `app/orders/new/page.tsx`

**æ”¹è¿›ï¼š**
- æŒ‰é˜¶æ®µåˆ†ç»„æ˜¾ç¤º Gate
- æ˜¾ç¤ºæ¯ä¸ª Gate çš„ `required` æ ‡è¯†ï¼ˆå¼ºåˆ¶/å»ºè®®ï¼‰
- æ˜¾ç¤º `evidence_required` æ ‡è¯†ï¼ˆéœ€å‡­è¯ï¼‰
- æ›´æ–°æ–‡æ¡ˆï¼š"ç³»ç»Ÿå°†ä¸ºä½ ç”Ÿæˆå®Œæ•´å¤–è´¸æ‰§è¡ŒèŠ‚æ‹ï¼ˆçº¦ 17 ä¸ªå…³é”®æ§åˆ¶ç‚¹ï¼‰"
- æ·»åŠ è®¾è®¡ç†å¿µè¯´æ˜ï¼š"å¡é£é™©ï¼Œè€Œä¸æ˜¯èµ°æµç¨‹"

**UI ç‰¹æ€§ï¼š**
- é˜¶æ®µæ ‡é¢˜å¸¦å›¾æ ‡å’Œé¢œè‰²åŒºåˆ†
- æ¯ä¸ª Gate æ˜¾ç¤ºè´Ÿè´£äººã€æˆªæ­¢æ—¥æœŸã€çŠ¶æ€
- å¼ºåˆ¶ Gate æ˜¾ç¤ºçº¢è‰²"å¼ºåˆ¶"æ ‡ç­¾
- å»ºè®® Gate æ˜¾ç¤ºç°è‰²"å»ºè®®"æ ‡ç­¾

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. âœ… `lib/domain/gateTemplate.ts` - Gate æ¨¡æ¿å®šä¹‰
2. âœ… `lib/utils/gate-scheduler.ts` - Gate æ—¶é—´è®¡ç®—å’Œä¾èµ–æ£€æŸ¥

### ä¿®æ”¹æ–‡ä»¶
1. âœ… `app/actions/orders.ts` - ä½¿ç”¨æ–°çš„ Gate æ¨¡æ¿
2. âœ… `app/orders/new/page.tsx` - Step 2 UI å‡çº§
3. âœ… `lib/repositories/milestonesRepo.ts` - æ·»åŠ ä¾èµ–æ£€æŸ¥é€»è¾‘

---

## ğŸ”‘ å…³é”® Diff

### `lib/domain/gateTemplate.ts` (æ–°å¢)

```typescript
export const GATE_TEMPLATE_V2: GateTemplate[] = [
  {
    gate_key: 'po_confirmed',
    name: 'POç¡®è®¤',
    stage: 'è®¢å•åˆæ³•æ€§',
    owner_role: 'sales',
    required: true,
    depends_on: [],
    days_before_target: 0,
    is_critical: true,
    evidence_required: false,
  },
  // ... 17 ä¸ª Gate
];
```

### `app/actions/orders.ts`

```diff
- import { MILESTONE_TEMPLATE_V1 } from '@/lib/milestoneTemplate';
- import { calcDueDates } from '@/lib/schedule';
+ import { calculateGateSchedule } from '@/lib/utils/gate-scheduler';

- const dueMap = calcDueDates({...});
- const rows = MILESTONE_TEMPLATE_V1.map((m) => {...});
+ const gateSchedules = calculateGateSchedule({...});
+ const milestonesData = gateSchedules.map((gate, index) => ({
+   step_key: gate.gate_key,
+   name: gate.name,
+   stage: gate.stage,
+   required: gate.required,
+   depends_on: gate.depends_on,
+   ...
+ }));
```

### `lib/repositories/milestonesRepo.ts`

```typescript
// æ–°å¢ä¾èµ–æ£€æŸ¥å‡½æ•°
async function checkGateDependencies(...) {
  // æ£€æŸ¥ä¾èµ–çš„ required Gate æ˜¯å¦å·²å®Œæˆ
}

// åœ¨ transitionMilestoneStatus ä¸­é›†æˆ
if (normalizedNextStatus === 'è¿›è¡Œä¸­') {
  const depCheck = await checkGateDependencies(...);
  if (!depCheck.canProceed) {
    return { error: depCheck.reason };
  }
}
```

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. Gate ä¾èµ–é“¾

**ç¤ºä¾‹ï¼š**
- "åŸè¾…æ–™é‡‡è´­" ä¾èµ– "è´¢åŠ¡å®¡æ ¸" å’Œ "è®¢å•èµ„æ–™é½å…¨"ï¼ˆéƒ½æ˜¯ requiredï¼‰
- "äº§å‰æ ·å®Œæˆ" ä¾èµ– "åŸè¾…æ–™éªŒæ”¶"ï¼ˆrequiredï¼‰
- "å·¥å‚ä¸Šçº¿" ä¾èµ– "äº§å‰æ ·ç¡®è®¤"ï¼ˆrequiredï¼‰

**æ•ˆæœï¼š**
- å¦‚æœ "è´¢åŠ¡å®¡æ ¸" æœªå®Œæˆï¼Œæ— æ³•å¼€å§‹ "åŸè¾…æ–™é‡‡è´­"
- å¦‚æœ "åŸè¾…æ–™éªŒæ”¶" æœªå®Œæˆï¼Œæ— æ³•å¼€å§‹ "äº§å‰æ ·å®Œæˆ"

### 2. é˜¶æ®µåˆ†ç»„

**5 ä¸ªé˜¶æ®µï¼š**
1. ğŸ” è®¢å•åˆæ³•æ€§ï¼ˆ3ä¸ª Gateï¼‰
2. ğŸ“¦ åŸè¾…æ–™ï¼ˆ3ä¸ª Gateï¼‰
3. ğŸ­ ç”Ÿäº§ï¼ˆ7ä¸ª Gateï¼‰
4. âœ… QCï¼ˆ2ä¸ª Gateï¼‰
5. ğŸš¢ å‡ºè´§ï¼ˆ2ä¸ª Gateï¼‰

### 3. å¼ºåˆ¶ vs å»ºè®®

- **å¼ºåˆ¶ Gate**ï¼šå¿…é¡»å®Œæˆæ‰èƒ½ç»§ç»­åç»­ required Gate
- **å»ºè®® Gate**ï¼šå¯é€‰ï¼Œä½†å»ºè®®å®Œæˆï¼ˆå¦‚"ä¸­æŸ¥"ï¼‰

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1ï¼šåˆ›å»ºè®¢å•å¹¶ç”Ÿæˆ Gate

**æ­¥éª¤ï¼š**
1. è®¿é—® `/orders/new`
2. å¡«å†™è®¢å•ä¿¡æ¯
3. ç‚¹å‡»"ä¸‹ä¸€æ­¥"

**é¢„æœŸï¼š**
- âœ… Step 2 æ˜¾ç¤º 17 ä¸ª Gate
- âœ… Gate æŒ‰ 5 ä¸ªé˜¶æ®µåˆ†ç»„
- âœ… æ¯ä¸ª Gate æ˜¾ç¤ºè´Ÿè´£äººã€æˆªæ­¢æ—¥æœŸã€çŠ¶æ€
- âœ… å¼ºåˆ¶ Gate æ˜¾ç¤ºçº¢è‰²"å¼ºåˆ¶"æ ‡ç­¾

---

### æµ‹è¯• 2ï¼šGate ä¾èµ–æ£€æŸ¥

**æ­¥éª¤ï¼š**
1. åˆ›å»ºè®¢å•åè¿›å…¥è®¢å•è¯¦æƒ…é¡µ
2. å°è¯•å°† "åŸè¾…æ–™é‡‡è´­" è®¾ç½®ä¸º"è¿›è¡Œä¸­"ï¼ˆæ­¤æ—¶ "è´¢åŠ¡å®¡æ ¸" æœªå®Œæˆï¼‰

**é¢„æœŸï¼š**
- âœ… ç³»ç»Ÿæç¤ºï¼š"ä¾èµ–çš„å¼ºåˆ¶æ§åˆ¶ç‚¹'è´¢åŠ¡å®¡æ ¸'å°šæœªå®Œæˆï¼Œæ— æ³•å¼€å§‹æ­¤æ§åˆ¶ç‚¹"
- âœ… çŠ¶æ€æ›´æ–°å¤±è´¥

**æ­¥éª¤ï¼š**
3. å®Œæˆ "è´¢åŠ¡å®¡æ ¸" å’Œ "è®¢å•èµ„æ–™é½å…¨"
4. å†æ¬¡å°è¯•å°† "åŸè¾…æ–™é‡‡è´­" è®¾ç½®ä¸º"è¿›è¡Œä¸­"

**é¢„æœŸï¼š**
- âœ… çŠ¶æ€æ›´æ–°æˆåŠŸ

---

### æµ‹è¯• 3ï¼šGate æ—¶é—´è®¡ç®—

**æ­¥éª¤ï¼š**
1. åˆ›å»º FOB è®¢å•ï¼ŒETD = 2026-03-25
2. æŸ¥çœ‹ç”Ÿæˆçš„ Gate æ—¶é—´

**é¢„æœŸï¼š**
- âœ… "è®¢èˆ±å®Œæˆ" çš„ due_at = ETD - 7 å¤© = 2026-03-18
- âœ… "å‡ºè´§å®Œæˆ" çš„ due_at = ETD = 2026-03-25
- âœ… å…¶ä»– Gate æŒ‰ `days_before_target` è®¡ç®—

---

## ğŸ“Š æ•°æ®åº“å…¼å®¹æ€§

### å½“å‰è¡¨ç»“æ„

**milestones è¡¨å­—æ®µï¼š**
- `step_key` âœ…ï¼ˆå¯¹åº” `gate_key`ï¼‰
- `name` âœ…
- `owner_role` âœ…
- `planned_at` âœ…
- `due_at` âœ…
- `status` âœ…
- `is_critical` âœ…
- `evidence_required` âœ…
- `notes` âœ…
- `sequence_number` âœ…

**æ–°å¢å­—æ®µï¼ˆå¯é€‰ï¼Œå¦‚æœè¡¨æ”¯æŒï¼‰ï¼š**
- `stage` - Gate æ‰€å±é˜¶æ®µ
- `required` - æ˜¯å¦ä¸ºå¼ºåˆ¶ Gate
- `depends_on` - ä¾èµ–çš„ gate_key åˆ—è¡¨ï¼ˆJSON æ•°ç»„ï¼‰

**æ³¨æ„ï¼š**
- å¦‚æœè¡¨æ²¡æœ‰ `stage`ã€`required`ã€`depends_on` å­—æ®µï¼Œç³»ç»Ÿä¼šï¼š
  - åœ¨åˆ›å»ºæ—¶ä¼ é€’è¿™äº›å­—æ®µï¼ˆæ•°æ®åº“å‡½æ•°ä¼šå¿½ç•¥ä¸å­˜åœ¨çš„å­—æ®µï¼‰
  - åœ¨ UI ä¸­æŒ‰ `sequence_number` æ¨æ–­é˜¶æ®µ
  - ä¾èµ–æ£€æŸ¥é€šè¿‡ `depends_on` å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œè·³è¿‡æ£€æŸ¥ï¼‰

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. ä»£ç å·²æ›´æ–° âœ…

æ‰€æœ‰ä»£ç ä¿®æ”¹å·²å®Œæˆï¼Œæ— éœ€é¢å¤–æ­¥éª¤ã€‚

### 2. æµ‹è¯•åˆ›å»ºè®¢å•

1. è®¿é—® http://localhost:3001/orders/new
2. å¡«å†™è®¢å•ä¿¡æ¯
3. ç‚¹å‡»"ä¸‹ä¸€æ­¥"
4. âœ… åº”è¯¥çœ‹åˆ° 17 ä¸ª Gateï¼ŒæŒ‰ 5 ä¸ªé˜¶æ®µåˆ†ç»„

### 3. æµ‹è¯•ä¾èµ–æ£€æŸ¥

1. è¿›å…¥è®¢å•è¯¦æƒ…é¡µ
2. å°è¯•è¿åä¾èµ–è§„åˆ™æ›´æ–° Gate çŠ¶æ€
3. âœ… åº”è¯¥çœ‹åˆ°ä¾èµ–æ£€æŸ¥é”™è¯¯æç¤º

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“å­—æ®µæ‰©å±•ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æŒä¹…åŒ– `stage`ã€`required`ã€`depends_on`ï¼š

```sql
ALTER TABLE public.milestones
ADD COLUMN IF NOT EXISTS stage text,
ADD COLUMN IF NOT EXISTS required boolean DEFAULT false,
ADD COLUMN IF NOT EXISTS depends_on jsonb DEFAULT '[]'::jsonb;
```

### 2. Gate æ¨¡æ¿é…ç½®åŒ–

å°† Gate æ¨¡æ¿å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œæ”¯æŒåŠ¨æ€é…ç½®ã€‚

### 3. Gate å¯è§†åŒ–

åœ¨è®¢å•è¯¦æƒ…é¡µæ·»åŠ  Gate ä¾èµ–å…³ç³»å›¾ã€‚

---

## âœ… äº¤ä»˜æ£€æŸ¥æ¸…å•

- [x] Gate æ¨¡æ¿è®¾è®¡å®Œæˆï¼ˆ17ä¸ªæ§åˆ¶ç‚¹ï¼‰
- [x] Gate æ—¶é—´è®¡ç®—é€»è¾‘å®Œæˆ
- [x] Gate ä¾èµ–æ£€æŸ¥é€»è¾‘å®Œæˆ
- [x] åˆ›å»ºè®¢å•æµç¨‹æ›´æ–°å®Œæˆ
- [x] Step 2 UI å‡çº§å®Œæˆ
- [x] ä»£ç æ„å»ºæˆåŠŸ
- [ ] æ‰‹åŠ¨æµ‹è¯•åˆ›å»ºè®¢å•æˆåŠŸ
- [ ] æ‰‹åŠ¨æµ‹è¯•ä¾èµ–æ£€æŸ¥ç”Ÿæ•ˆ
- [ ] æ‰‹åŠ¨æµ‹è¯• Gate æ—¶é—´è®¡ç®—æ­£ç¡®

---

**å‡çº§å®Œæˆæ—¶é—´ï¼š** 2024-01-21  
**çŠ¶æ€ï¼š** âœ… ä»£ç å®Œæˆï¼Œç­‰å¾…æµ‹è¯•éªŒè¯
