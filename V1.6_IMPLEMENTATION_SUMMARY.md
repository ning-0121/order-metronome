# è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç† V1.6 å®ç°æ€»ç»“

## ğŸ“‹ äº¤ä»˜æ¸…å•

### âœ… å·²å®ŒæˆåŠŸèƒ½

1. **è®¢å•å‡ºç”Ÿï¼ˆBirthï¼‰**ï¼šè®¢å•åˆ›å»ºåé»˜è®¤"è‰ç¨¿"ï¼Œå¿…é¡»æ˜¾å¼"æ¿€æ´»"æ‰è¿›å…¥æ‰§è¡Œä½“ç³»
2. **è®¢å•æ‰§è¡Œï¼ˆExecutionï¼‰**ï¼šåªæœ‰å·²æ¿€æ´»/æ‰§è¡Œä¸­çš„è®¢å•ï¼Œæ‰èƒ½æ¨è¿›é‡Œç¨‹ç¢‘çŠ¶æ€
3. **è®¢å•ç»ˆç»“ï¼ˆTerminationï¼‰**ï¼šè®¢å•åªæœ‰ä¸¤ç§åˆæ³•ç»ˆç»“ï¼šå·²å®Œæˆ / å·²å–æ¶ˆï¼ˆå–æ¶ˆå¿…é¡»ç”³è¯·+å®¡æ‰¹+åŸå› ï¼‰
4. **è®¢å•å¤ç›˜ï¼ˆRetrospectiveï¼‰**ï¼šç»ˆç»“åè‡ªåŠ¨è¿›å…¥"å¾…å¤ç›˜"ï¼Œå®Œæˆå¤ç›˜åæ‰ç®—"å·²å¤ç›˜/é—­ç¯"
5. **ç•™ç—•ï¼ˆAuditï¼‰**ï¼šæ‰€æœ‰ç”Ÿå‘½å‘¨æœŸå˜æ›´å¿…é¡»å†™å…¥è®¢å•æ—¥å¿—(order_logs)ï¼Œé‡Œç¨‹ç¢‘å˜æ›´ç»§ç»­å†™ milestone_logs
6. **å…¥å£å°æ­»**ï¼šæ‰€æœ‰ç»•å¼€èŠ‚æ‹å™¨çš„è¡Œä¸ºéƒ½æ— æ•ˆ

---

## ğŸ“ æ–°å¢/ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ•°æ®åº“è¿ç§»

1. **`supabase/migrations/20240121000000_add_order_lifecycle.sql`** â­ æ–°å¢
   - orders è¡¨æ–°å¢ç”Ÿå‘½å‘¨æœŸå­—æ®µ
   - order_logs è¡¨ï¼ˆè®¢å•äº‹ä»¶æ—¥å¿—ï¼‰
   - cancel_requests è¡¨ï¼ˆå–æ¶ˆç”³è¯·ä¸å®¡æ‰¹ï¼‰
   - order_retrospectives è¡¨ï¼ˆå¤ç›˜ï¼‰
   - RLS ç­–ç•¥

### Domain å±‚

2. **`lib/domain/types.ts`** âœï¸ ä¿®æ”¹
   - æ–°å¢ `OrderLifecycleStatus` æšä¸¾
   - æ–°å¢ `ORDER_LIFECYCLE_TRANSITIONS` çŠ¶æ€è½¬æ¢è§„åˆ™
   - æ–°å¢ `transitionOrderLifecycle()` å‡½æ•°
   - æ–°å¢ `canModifyMilestones()` å‡½æ•°

### Repository å±‚

3. **`lib/repositories/ordersRepo.ts`** âœï¸ ä¿®æ”¹
   - æ–°å¢ `logOrderEvent()` å‡½æ•°
   - æ–°å¢ `activateOrder()` å‡½æ•°
   - æ–°å¢ `startExecution()` å‡½æ•°
   - æ–°å¢ `requestCancel()` å‡½æ•°
   - æ–°å¢ `decideCancel()` å‡½æ•°
   - æ–°å¢ `completeOrder()` å‡½æ•°
   - æ–°å¢ `submitRetrospective()` å‡½æ•°

4. **`lib/repositories/milestonesRepo.ts`** âœï¸ ä¿®æ”¹
   - `transitionMilestoneStatus()` å¢åŠ è®¢å•ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æ ¡éªŒ
   - `updateMilestone()` å¢åŠ è®¢å•ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æ ¡éªŒ

### Server Actions

5. **`app/actions/orders.ts`** âœï¸ ä¿®æ”¹
   - æ–°å¢ `activateOrderAction()` 
   - æ–°å¢ `requestCancelAction()`
   - æ–°å¢ `decideCancelAction()`
   - æ–°å¢ `completeOrderAction()`
   - æ–°å¢ `submitRetrospectiveAction()`
   - æ–°å¢ `getOrderLogs()`
   - æ–°å¢ `getCancelRequests()`
   - æ–°å¢ `getRetrospective()`

### UI ç»„ä»¶

6. **`components/OrderLifecycle.tsx`** â­ æ–°å¢
   - ç”Ÿå‘½å‘¨æœŸæ¡ç»„ä»¶
   - å¾…å¤ç›˜æç¤º

7. **`components/OrderLifecycleActions.tsx`** â­ æ–°å¢
   - æ¿€æ´»è®¢å•æŒ‰é’®
   - ç”³è¯·å–æ¶ˆè®¢å•è¡¨å•
   - å®Œæˆè®¢å•æŒ‰é’®

8. **`app/orders/[id]/page.tsx`** âœï¸ ä¿®æ”¹
   - æ·»åŠ ç”Ÿå‘½å‘¨æœŸæ¡
   - æ·»åŠ ç”Ÿå‘½å‘¨æœŸæ“ä½œæŒ‰é’®
   - æ˜¾ç¤ºç”Ÿå‘½å‘¨æœŸçŠ¶æ€ä¿¡æ¯

9. **`app/orders/[id]/retrospective/page.tsx`** â­ æ–°å¢
   - å¤ç›˜é¡µé¢å®Œæ•´å®ç°
   - è¡¨å•éªŒè¯
   - æ”¹è¿›æªæ–½ç®¡ç†

10. **`app/dashboard/page.tsx`** âœï¸ ä¿®æ”¹
    - æ–°å¢"å¾…å¤ç›˜è®¢å•"æ¨¡å—ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    - ç´«è‰²é«˜äº®æ˜¾ç¤º

### æµ‹è¯•æ–‡æ¡£

11. **`TEST_LIFECYCLE.md`** â­ æ–°å¢
    - å®Œæ•´æµ‹è¯•æ­¥éª¤
    - å…¥å£å°æ­»ç‚¹æ¸…å•
    - å¸¸è§é—®é¢˜è§£ç­”

---

## ğŸ”’ å…¥å£å°æ­»ç‚¹æ¸…å•

### Repository å±‚å°æ­»ç‚¹

| å‡½æ•° | å°æ­»ç‚¹ | ä½ç½® |
|------|--------|------|
| `activateOrder()` | åªæœ‰ `lifecycle_status='è‰ç¨¿'` æ‰èƒ½æ¿€æ´» | `lib/repositories/ordersRepo.ts:340` |
| `startExecution()` | åªæœ‰ `lifecycle_status='å·²ç”Ÿæ•ˆ'` æ‰èƒ½å¼€å§‹æ‰§è¡Œ | `lib/repositories/ordersRepo.ts:380` |
| `requestCancel()` | åªæœ‰ `lifecycle_status='æ‰§è¡Œä¸­'` æ‰èƒ½ç”³è¯·å–æ¶ˆ | `lib/repositories/ordersRepo.ts:420` |
| `decideCancel()` | å–æ¶ˆç”³è¯·çŠ¶æ€å¿…é¡»ä¸º `pending`ï¼Œè®¢å•å¿…é¡»ä¸º `æ‰§è¡Œä¸­` | `lib/repositories/ordersRepo.ts:460` |
| `completeOrder()` | åªæœ‰ `lifecycle_status='æ‰§è¡Œä¸­'` ä¸”æ‰€æœ‰é‡Œç¨‹ç¢‘å·²å®Œæˆ | `lib/repositories/ordersRepo.ts:560` |
| `submitRetrospective()` | åªæœ‰ `lifecycle_status='å¾…å¤ç›˜'` æ‰èƒ½æäº¤å¤ç›˜ | `lib/repositories/ordersRepo.ts:650` |
| `transitionMilestoneStatus()` | è®¢å•çŠ¶æ€å¿…é¡»ä¸º `å·²ç”Ÿæ•ˆ` æˆ– `æ‰§è¡Œä¸­` | `lib/repositories/milestonesRepo.ts:295` |
| `updateMilestone()` | è®¢å•çŠ¶æ€å¿…é¡»ä¸º `å·²ç”Ÿæ•ˆ` æˆ– `æ‰§è¡Œä¸­` | `lib/repositories/milestonesRepo.ts:365` |

### Domain å±‚å°æ­»ç‚¹

| å‡½æ•° | å°æ­»ç‚¹ | ä½ç½® |
|------|--------|------|
| `transitionOrderLifecycle()` | çŠ¶æ€è½¬æ¢å¿…é¡»ç¬¦åˆ `ORDER_LIFECYCLE_TRANSITIONS` è§„åˆ™ | `lib/domain/types.ts:120` |
| `canModifyMilestones()` | åªæœ‰ `å·²ç”Ÿæ•ˆ` å’Œ `æ‰§è¡Œä¸­` çŠ¶æ€çš„è®¢å•æ‰å…è®¸é‡Œç¨‹ç¢‘å˜æ›´ | `lib/domain/types.ts:140` |

### UI å±‚å°æ­»ç‚¹

| ç»„ä»¶/é¡µé¢ | å°æ­»ç‚¹ | ä½ç½® |
|----------|--------|------|
| `OrderLifecycleActions` | è‰ç¨¿çŠ¶æ€åªæ˜¾ç¤º"æ¿€æ´»è®¢å•"æŒ‰é’® | `components/OrderLifecycleActions.tsx:30` |
| `OrderLifecycleActions` | æ‰§è¡Œä¸­çŠ¶æ€æ˜¾ç¤º"ç»“æ¡ˆ"å’Œ"ç”³è¯·å–æ¶ˆ"æŒ‰é’® | `components/OrderLifecycleActions.tsx:50` |
| `OrderLifecycleActions` | ç»“æ¡ˆæŒ‰é’®åªæœ‰æ‰€æœ‰é‡Œç¨‹ç¢‘å®Œæˆæ—¶æ‰å¯ç‚¹å‡» | `components/OrderLifecycleActions.tsx:90` |
| `retrospective/page.tsx` | åªæœ‰"å¾…å¤ç›˜"çŠ¶æ€çš„è®¢å•æ‰èƒ½è®¿é—®å¤ç›˜é¡µé¢ | `app/orders/[id]/retrospective/page.tsx:120` |
| `retrospective/page.tsx` | è¡¨å•éªŒè¯ï¼šå¿…å¡«å­—æ®µæ£€æŸ¥ | `app/orders/[id]/retrospective/page.tsx:200` |
| `dashboard/page.tsx` | å¾…å¤ç›˜è®¢å•æ¨¡å—æ˜¾ç¤ºæ‰€æœ‰ `lifecycle_status='å¾…å¤ç›˜'` çš„è®¢å• | `app/dashboard/page.tsx:40` |

---

## ğŸ¯ çŠ¶æ€è½¬æ¢è§„åˆ™

### è®¢å•ç”Ÿå‘½å‘¨æœŸçŠ¶æ€è½¬æ¢

```
è‰ç¨¿ â†’ å·²ç”Ÿæ•ˆ â†’ æ‰§è¡Œä¸­ â†’ å·²å®Œæˆ â†’ å¾…å¤ç›˜ â†’ å·²å¤ç›˜
                    â†“
                  å·²å–æ¶ˆ â†’ å¾…å¤ç›˜ â†’ å·²å¤ç›˜
```

**ç¦æ­¢çš„è½¬æ¢ï¼š**
- âŒ ä»»ä½•å›é€€
- âŒ è‰ç¨¿ç›´æ¥æ‰§è¡Œä¸­/å·²å®Œæˆ/å·²å–æ¶ˆ
- âŒ å·²å®Œæˆ/å·²å–æ¶ˆç›´æ¥å·²å¤ç›˜ï¼ˆå¿…é¡»å…ˆå¾…å¤ç›˜ï¼‰

### é‡Œç¨‹ç¢‘çŠ¶æ€å˜æ›´é™åˆ¶

**å…è®¸å˜æ›´çš„è®¢å•çŠ¶æ€ï¼š**
- âœ… `å·²ç”Ÿæ•ˆ`
- âœ… `æ‰§è¡Œä¸­`

**ç¦æ­¢å˜æ›´çš„è®¢å•çŠ¶æ€ï¼š**
- âŒ `è‰ç¨¿`
- âŒ `å·²å®Œæˆ`
- âŒ `å·²å–æ¶ˆ`
- âŒ `å¾…å¤ç›˜`
- âŒ `å·²å¤ç›˜`

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### orders è¡¨æ–°å¢å­—æ®µ

- `lifecycle_status` text not null default 'è‰ç¨¿'
- `activated_at` timestamptz null
- `terminated_at` timestamptz null
- `termination_type` text null ('å®Œæˆ'/'å–æ¶ˆ')
- `termination_reason` text null
- `termination_approved_by` uuid null
- `retrospective_required` boolean not null default true
- `retrospective_completed_at` timestamptz null

### order_logs è¡¨

- `id` uuid pk
- `order_id` uuid fk â†’ orders
- `actor_user_id` uuid fk â†’ auth.users
- `action` text not null
- `from_status` text null
- `to_status` text null
- `note` text null
- `payload` jsonb null
- `created_at` timestamptz

### cancel_requests è¡¨

- `id` uuid pk
- `order_id` uuid fk â†’ orders
- `requested_by` uuid fk â†’ auth.users
- `reason_type` text not null
- `reason_detail` text not null
- `status` text not null default 'pending'
- `decided_by` uuid null
- `decided_at` timestamptz null
- `decision_note` text null

### order_retrospectives è¡¨

- `id` uuid pk
- `order_id` uuid fk â†’ orders (unique)
- `owner_user_id` uuid fk â†’ auth.users
- `on_time_delivery` boolean null
- `major_delay_reason` text null
- `blocked_count` int not null default 0
- `delay_request_count` int not null default 0
- `key_issue` text not null
- `root_cause` text not null
- `what_worked` text not null
- `improvement_actions` jsonb not null default '[]'::jsonb

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ„å»ºçŠ¶æ€

- âœ… TypeScript ç¼–è¯‘é€šè¿‡
- âœ… `npm run build` æ„å»ºæˆåŠŸ
- âœ… æ— ç±»å‹é”™è¯¯

### æµ‹è¯•è¦†ç›–

å‚è€ƒ `TEST_LIFECYCLE.md` è¿›è¡Œå®Œæ•´æµ‹è¯•ã€‚

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**
   ```sql
   -- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
   -- supabase/migrations/20240121000000_add_order_lifecycle.sql
   ```

2. **éªŒè¯è¿ç§»**
   - æ£€æŸ¥ orders è¡¨æ˜¯å¦æœ‰æ–°å­—æ®µ
   - æ£€æŸ¥æ–°è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
   - æ£€æŸ¥ RLS ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆ

3. **æµ‹è¯•åŠŸèƒ½**
   - æŒ‰ç…§ `TEST_LIFECYCLE.md` è¿›è¡Œæµ‹è¯•
   - éªŒè¯æ‰€æœ‰å…¥å£å°æ­»ç‚¹æ­£å¸¸å·¥ä½œ

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è®¢å•åˆ›å»ºæ—¶é»˜è®¤çŠ¶æ€ä¸º"è‰ç¨¿"**
   - éœ€è¦æ˜¾å¼æ¿€æ´»æ‰èƒ½è¿›å…¥æ‰§è¡Œä½“ç³»
   - æ¿€æ´»åè‡ªåŠ¨è¿›å…¥"æ‰§è¡Œä¸­"çŠ¶æ€

2. **é‡Œç¨‹ç¢‘çŠ¶æ€å˜æ›´é™åˆ¶**
   - åªæœ‰"å·²ç”Ÿæ•ˆ"å’Œ"æ‰§è¡Œä¸­"çŠ¶æ€çš„è®¢å•æ‰èƒ½ä¿®æ”¹é‡Œç¨‹ç¢‘
   - æ‰€æœ‰å…¶ä»–çŠ¶æ€çš„è®¢å•ï¼Œé‡Œç¨‹ç¢‘ä¸ºåªè¯»

3. **å–æ¶ˆè®¢å•æµç¨‹**
   - å¿…é¡»å…ˆç”³è¯·å–æ¶ˆ
   - éœ€è¦å®¡æ‰¹ï¼ˆè®¢å•ownerï¼‰
   - æ‰¹å‡†åè‡ªåŠ¨è¿›å…¥"å·²å–æ¶ˆ"çŠ¶æ€
   - å¦‚æœ `retrospective_required=true`ï¼Œè‡ªåŠ¨è¿›å…¥"å¾…å¤ç›˜"

4. **å®Œæˆè®¢å•æµç¨‹**
   - æ‰€æœ‰é‡Œç¨‹ç¢‘å¿…é¡»å·²å®Œæˆ
   - å®Œæˆåè‡ªåŠ¨è¿›å…¥"å·²å®Œæˆ"çŠ¶æ€
   - å¦‚æœ `retrospective_required=true`ï¼Œè‡ªåŠ¨è¿›å…¥"å¾…å¤ç›˜"

5. **å¤ç›˜æµç¨‹**
   - åªæœ‰"å¾…å¤ç›˜"çŠ¶æ€çš„è®¢å•æ‰èƒ½æäº¤å¤ç›˜
   - å¿…å¡«å­—æ®µï¼šå…³é”®é—®é¢˜ã€æ ¹æœ¬åŸå› ã€åšå¾—å¥½çš„åœ°æ–¹
   - è‡³å°‘éœ€è¦1æ¡æ”¹è¿›æªæ–½
   - æäº¤åè¿›å…¥"å·²å¤ç›˜"çŠ¶æ€

---

**ç‰ˆæœ¬ï¼š** V1.6  
**æœ€åæ›´æ–°ï¼š** 2024-01-21  
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡
